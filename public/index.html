<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Database Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-inactive {
            background: #f8f9fa;
            color: #6b7280;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .upload-zone:hover {
            border-color: #6366f1;
            background-color: #f8faff;
        }
        .upload-zone.dragover {
            border-color: #6366f1;
            background-color: #eff6ff;
        }
        .field-options {
        transition: all 0.3s ease;
    }

    #formBuilderModal input:focus,
    #formBuilderModal select:focus,
    #formBuilderModal textarea:focus {
        outline: none;
        ring: 2px;
        ring-color: #3b82f6;
        border-color: #3b82f6;
    }

    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <h1 class="text-2xl font-bold text-gray-900">Document Database System</h1>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        <span id="currentTime"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Navigation Tabs -->
            <div class="flex flex-wrap gap-2 mb-8 p-1 bg-gray-100 rounded-lg">
                <button onclick="switchTab('upload')" id="tab-upload" class="tab-active px-4 py-2 rounded-md font-medium transition-colors">
                    üìÅ Upload Documents
                </button>
                <button onclick="switchTab('forms')" id="tab-forms" class="tab-inactive px-4 py-2 rounded-md font-medium transition-colors">
                    üìã Forms & Templates
                </button>
                <button onclick="switchTab('csv')" id="tab-csv" class="tab-inactive px-4 py-2 rounded-md font-medium transition-colors">
                    üìä CSV Processing
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="tab-inactive px-4 py-2 rounded-md font-medium transition-colors">
                    üìà History
                </button>
            </div>

            <!-- Database Selection -->
            <div class="mb-8 p-6 bg-white rounded-xl shadow-sm border">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Select Database</h2>
                <select id="databaseSelect" class="w-full max-w-md px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Choose a database...</option>
                    <option value="customers">Customers</option>
                    <option value="inventory">Inventory</option>
                    <option value="orders">Orders</option>
                    <option value="employees">Employees</option>
                </select>
                <p class="mt-2 text-sm text-gray-600">Select which database to store your data in</p>
            </div>

            <!-- Tab Content -->
            <div id="content-upload" class="tab-content">
                <!-- Document Upload Section -->
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Upload Document</h2>
                    
                    <form id="documentUploadForm" enctype="multipart/form-data">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Document Name</label>
                            <input type="text" id="customName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter a custom name for this document">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                            <div class="upload-zone rounded-lg p-8 text-center" id="uploadZone">
                                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                                    <span class="text-blue-600 text-2xl">üìÑ</span>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-lg font-medium text-gray-900">Drop your file here or click to browse</p>
                                    <p class="text-sm text-gray-500">Supports PDF, DOC, DOCX, TXT, CSV files up to 50MB</p>
                                </div>
                                <input type="file" id="documentFile" class="hidden" accept=".pdf,.doc,.docx,.txt,.csv">
                                <button type="button" onclick="document.getElementById('documentFile').click()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Choose File
                                </button>
                            </div>
                            <div id="fileInfo" class="mt-3 hidden">
                                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-blue-600 mr-2">üìé</span>
                                    <span id="fileName" class="text-sm text-blue-800 font-medium"></span>
                                    <span id="fileSize" class="text-sm text-blue-600 ml-2"></span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="uploadBtn" class="w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            Upload Document
                        </button>
                    </form>

                    <div id="uploadStatus" class="mt-4"></div>
                </div>

                <!-- Documents List -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Uploaded Documents</h2>
                    <div id="documentsList">
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìÑ</div>
                            <p>No documents uploaded yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-forms" class="tab-content hidden">
                <!-- Forms Section -->
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">Form Templates</h2>
                        <button onclick="createCustomForm()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            ‚ûï Create Custom Form
                        </button>
                    </div>
                    
                    <div id="formsList">
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìã</div>
                            <p>No forms created yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-csv" class="tab-content hidden">
                <!-- CSV Processing Section -->
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">CSV Processing</h2>
                    
                    <form id="csvUploadForm" enctype="multipart/form-data">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File</label>
                            <div class="upload-zone rounded-lg p-8 text-center" id="csvUploadZone">
                                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                                    <span class="text-green-600 text-2xl">üìä</span>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-lg font-medium text-gray-900">Drop CSV file here or click to browse</p>
                                    <p class="text-sm text-gray-500">Automatically generates forms from CSV columns</p>
                                </div>
                                <input type="file" id="csvFile" class="hidden" accept=".csv">
                                <button type="button" onclick="document.getElementById('csvFile').click()" class="mt-4 px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                    Choose CSV File
                                </button>
                            </div>
                        </div>

                        <button type="submit" id="csvUploadBtn" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Upload & Process CSV
                        </button>
                    </form>

                    <div id="csvStatus" class="mt-4"></div>
                </div>

                <!-- CSV Files List -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Processed CSV Files</h2>
                    <div id="csvList">
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìä</div>
                            <p>No CSV files processed yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-history" class="tab-content hidden">
                <!-- History Section -->
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Activity History</h2>
                    <div id="historyList">
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìà</div>
                            <p>No activity recorded yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 m-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-4"></div>
                <span class="text-lg">Processing...</span>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTab = 'upload';
        let selectedDatabase = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            setupEventListeners();
            loadData();
        });

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString();
        }

        function setupEventListeners() {
            // Database selection
            document.getElementById('databaseSelect').addEventListener('change', function(e) {
                selectedDatabase = e.target.value;
                updateButtonStates();
            });

            // Document upload
            document.getElementById('documentUploadForm').addEventListener('submit', handleDocumentUpload);
            document.getElementById('documentFile').addEventListener('change', handleFileSelect);

            // CSV upload
            document.getElementById('csvUploadForm').addEventListener('submit', handleCSVUpload);
            document.getElementById('csvFile').addEventListener('change', handleCSVFileSelect);

            // Drag and drop
            setupDragAndDrop('uploadZone', 'documentFile');
            setupDragAndDrop('csvUploadZone', 'csvFile');
        }

        function setupDragAndDrop(zoneId, inputId) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    if (inputId === 'documentFile') {
                        handleFileSelect({ target: input });
                    } else {
                        handleCSVFileSelect({ target: input });
                    }
                }
            });
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = 'tab-inactive px-4 py-2 rounded-md font-medium transition-colors';
            });
            document.getElementById(`tab-${tabName}`).className = 'tab-active px-4 py-2 rounded-md font-medium transition-colors';

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            currentTab = tabName;
            loadData();
        }

        function updateButtonStates() {
            const hasDatabase = selectedDatabase !== '';
            document.getElementById('uploadBtn').disabled = !hasDatabase;
            document.getElementById('csvUploadBtn').disabled = !hasDatabase;
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = `(${formatFileSize(file.size)})`;
                document.getElementById('fileInfo').classList.remove('hidden');
            }
        }

        function handleCSVFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // Update UI to show selected file
                const zone = document.getElementById('csvUploadZone');
                zone.innerHTML = `
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <span class="text-green-600 text-2xl">üìä</span>
                    </div>
                    <p class="text-lg font-medium text-gray-900">${file.name}</p>
                    <p class="text-sm text-gray-500">(${formatFileSize(file.size)})</p>
                `;
            }
        }

        async function handleDocumentUpload(e) {
            e.preventDefault();
            
            if (!selectedDatabase) {
                showMessage('uploadStatus', 'Please select a database first', 'error');
                return;
            }

            const fileInput = document.getElementById('documentFile');
            const customName = document.getElementById('customName').value;

            if (!fileInput.files[0]) {
                showMessage('uploadStatus', 'Please select a file to upload', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('document', fileInput.files[0]);
            formData.append('customName', customName);
            formData.append('database', selectedDatabase);

            showLoading(true);
            showMessage('uploadStatus', 'Uploading and processing document...', 'info');

            try {
                const response = await fetch('/api/upload-document', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('uploadStatus', 'Document uploaded and processed successfully!', 'success');
                    document.getElementById('documentUploadForm').reset();
                    document.getElementById('fileInfo').classList.add('hidden');
                    loadDocuments();
                } else {
                    showMessage('uploadStatus', `Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('uploadStatus', `Upload failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCSVUpload(e) {
            e.preventDefault();
            
            if (!selectedDatabase) {
                showMessage('csvStatus', 'Please select a database first', 'error');
                return;
            }

            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files[0]) {
                showMessage('csvStatus', 'Please select a CSV file to upload', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('csv', fileInput.files[0]);

            showLoading(true);
            showMessage('csvStatus', 'Processing CSV file...', 'info');

            try {
                const response = await fetch('/api/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('csvStatus', `CSV processed: ${result.headers.length} columns, ${result.rowCount} rows`, 'success');
                    
                    if (result.canGenerateForm) {
                        showMessage('csvStatus', 'CSV processed successfully! Generating form...', 'info');
                        await generateFormFromCSV(result.csvId);
                    }
                    
                    document.getElementById('csvUploadForm').reset();
                    resetCSVUploadZone();
                    loadCSVData();
                } else {
                    showMessage('csvStatus', `Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('csvStatus', `CSV processing failed: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function generateFormFromCSV(csvId) {
            try {
                const response = await fetch('/api/generate-form-from-csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        csvId: csvId,
                        database: selectedDatabase
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('csvStatus', `Form generated successfully! Web link: ${result.form.webLink}`, 'success');
                    loadForms();
                } else {
                    showMessage('csvStatus', `Form generation error: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('csvStatus', `Form generation failed: ${error.message}`, 'error');
            }
        }

        function resetCSVUploadZone() {
            document.getElementById('csvUploadZone').innerHTML = `
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <span class="text-green-600 text-2xl">üìä</span>
                </div>
                <div class="space-y-2">
                    <p class="text-lg font-medium text-gray-900">Drop CSV file here or click to browse</p>
                    <p class="text-sm text-gray-500">Automatically generates forms from CSV columns</p>
                </div>
                <button type="button" onclick="document.getElementById('csvFile').click()" class="mt-4 px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                    Choose CSV File
                </button>
            `;
        }

        async function loadData() {
            switch (currentTab) {
                case 'upload':
                    await loadDocuments();
                    break;
                case 'forms':
                    await loadForms();
                    break;
                case 'csv':
                    await loadCSVData();
                    break;
                case 'history':
                    await loadHistory();
                    break;
            }
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                const data = await response.json();
                
                const container = document.getElementById('documentsList');
                
                if (data.documents && data.documents.length > 0) {
                    container.innerHTML = data.documents.map(doc => `
                        <div class="border rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">üìÑ</div>
                                    <div>
                                        <h3 class="font-medium text-gray-900">${doc.customName}</h3>
                                        <p class="text-sm text-gray-600">Original: ${doc.originalName}</p>
                                        <p class="text-sm text-gray-500">Database: ${doc.database_name} | ${new Date(doc.uploadDate).toLocaleString()}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 text-xs rounded-full ${doc.status === 'processed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${doc.status}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìÑ</div>
                            <p>No documents uploaded yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        // Enhanced form loading with edit/view buttons
        async function loadForms() {
            try {
                const response = await fetch('/api/forms');
                const data = await response.json();
                
                const container = document.getElementById('formsList');
                
                if (data.forms && data.forms.length > 0) {
                    container.innerHTML = data.forms.map(form => {
                        const fields = typeof form.fields === 'string' ? JSON.parse(form.fields) : form.fields;
                        return `
                            <div class="border rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-medium text-gray-900">${form.name}</h3>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                            ${form.source}
                                        </span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                                            ${form.submissionCount || 0} submissions
                                        </span>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">
                                    Database: ${form.database_name} | Fields: ${fields.length} | Created: ${new Date(form.createdDate).toLocaleDateString()}
                                </p>
                                
                                <!-- Action Buttons -->
                                <div class="flex items-center space-x-2 mb-3">
                                    <button onclick="editForm('${form.id}')" class="px-3 py-1 text-sm bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 transition-colors">
                                        ‚úèÔ∏è Edit Form
                                    </button>
                                    <button onclick="viewFormSubmissions('${form.id}', '${form.name}')" class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors">
                                        üìä View Data
                                    </button>
                                    <button onclick="copyToClipboard('${form.webLink}')" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                                        üìã Copy Link
                                    </button>
                                    <a href="${form.webLink}" target="_blank" class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors">
                                        üëÅÔ∏è Preview
                                    </a>
                                    <button onclick="deleteForm('${form.id}', '${form.name}')" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                                
                                <div class="mt-2 text-xs text-gray-500 font-mono bg-gray-50 p-2 rounded break-all">
                                    ${form.webLink}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">üìã</div>
                            <p>No forms created yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading forms:', error);
            }
        }

        function createCustomForm() {
            if (!selectedDatabase) {
                alert('Please select a database first');
                return;
            }
            
            showFormBuilder();
        }

        // Edit existing form
        async function editForm(formId) {
            try {
                const response = await fetch(`/api/forms/${formId}`);
                const data = await response.json();
                
                if (!data.success) {
                    alert('Error loading form data');
                    return;
                }
                
                const form = data.form;
                const fields = typeof form.fields === 'string' ? JSON.parse(form.fields) : form.fields;
                
                // Show form builder with existing data
                showFormBuilder(form.name, fields, formId);
                
            } catch (error) {
                console.error('Error loading form for editing:', error);
                alert('Failed to load form data');
            }
        }

        // Enhanced form builder that can handle editing
        function showFormBuilder(existingName = '', existingFields = [], editFormId = null) {
            const modal = document.createElement('div');
            modal.id = 'formBuilderModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const isEditing = editFormId !== null;
            const title = isEditing ? 'Edit Form' : 'Create Custom Form';
            const saveButtonText = isEditing ? 'Update Form' : 'Create Form';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-900">${title}</h2>
                        <p class="text-gray-600 mt-2">${isEditing ? 'Modify your existing form' : 'Build a form with as many fields as you need'}</p>
                    </div>
                    
                    <div class="p-6">
                        <!-- Form Name -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Form Name</label>
                            <input type="text" id="formBuilderName" value="${existingName}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter form name">
                        </div>
                        
                        <!-- Fields Container -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <label class="block text-sm font-medium text-gray-700">Form Fields</label>
                                <button onclick="addFormField()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    ‚ûï Add Field
                                </button>
                            </div>
                            
                            <div id="formFieldsContainer" class="space-y-4">
                                <!-- Fields will be added here -->
                            </div>
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button onclick="closeFormBuilder()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                Cancel
                            </button>
                            <button onclick="saveCustomForm('${editFormId}')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                ${saveButtonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load existing fields or add initial field
            if (existingFields.length > 0) {
                existingFields.forEach(field => addFormField(field));
            } else {
                addFormField();
            }
            
            // Focus on form name
            document.getElementById('formBuilderName').focus();
        }

        // Enhanced addFormField that can handle existing field data
        function addFormField(existingField = null) {
            const container = document.getElementById('formFieldsContainer');
            const fieldIndex = container.children.length;
            
            // Use existing field data or defaults
            const fieldData = existingField || {
                name: `field_${fieldIndex + 1}`,
                label: `Field ${fieldIndex + 1}`,
                type: 'text',
                required: true,
                placeholder: '',
                options: []
            };
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
            fieldDiv.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-900">Field ${fieldIndex + 1}</h4>
                    <button onclick="removeFormField(this)" class="text-red-500 hover:text-red-700 text-sm">
                        üóëÔ∏è Remove
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Field Name</label>
                        <input type="text" class="field-name w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="field_name" value="${fieldData.name}">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Display Label</label>
                        <input type="text" class="field-label w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Field Label" value="${fieldData.label}">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Field Type</label>
                        <select class="field-type w-full px-2 py-1 border border-gray-300 rounded text-sm">
                            <option value="text" ${fieldData.type === 'text' ? 'selected' : ''}>Text</option>
                            <option value="email" ${fieldData.type === 'email' ? 'selected' : ''}>Email</option>
                            <option value="number" ${fieldData.type === 'number' ? 'selected' : ''}>Number</option>
                            <option value="date" ${fieldData.type === 'date' ? 'selected' : ''}>Date</option>
                            <option value="tel" ${fieldData.type === 'tel' ? 'selected' : ''}>Phone</option>
                            <option value="url" ${fieldData.type === 'url' ? 'selected' : ''}>URL</option>
                            <option value="textarea" ${fieldData.type === 'textarea' ? 'selected' : ''}>Long Text</option>
                            <option value="select" ${fieldData.type === 'select' ? 'selected' : ''}>Dropdown</option>
                            <option value="checkbox" ${fieldData.type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                            <option value="radio" ${fieldData.type === 'radio' ? 'selected' : ''}>Radio Buttons</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-3 flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" class="field-required mr-2" ${fieldData.required ? 'checked' : ''}>
                        <span class="text-xs text-gray-600">Required field</span>
                    </label>
                    
                    <div class="text-xs text-gray-500">
                        <input type="text" class="field-placeholder px-2 py-1 border border-gray-300 rounded text-xs w-32" placeholder="Placeholder text" value="${fieldData.placeholder || ''}">
                    </div>
                </div>
                
                <div class="mt-2 field-options ${fieldData.type === 'select' || fieldData.type === 'radio' ? '' : 'hidden'}">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Options (one per line)</label>
                    <textarea class="field-options-text w-full px-2 py-1 border border-gray-300 rounded text-sm h-16" placeholder="Option 1&#10;Option 2&#10;Option 3">${fieldData.options ? fieldData.options.join('\n') : ''}</textarea>
                </div>
            `;
            
            container.appendChild(fieldDiv);
            
            // Add event listener for field type changes
            const typeSelect = fieldDiv.querySelector('.field-type');
            typeSelect.addEventListener('change', function() {
                const optionsDiv = fieldDiv.querySelector('.field-options');
                if (this.value === 'select' || this.value === 'radio') {
                    optionsDiv.classList.remove('hidden');
                } else {
                    optionsDiv.classList.add('hidden');
                }
            });
        }

        function removeFormField(button) {
            const fieldDiv = button.closest('.border');
            fieldDiv.remove();
            
            // Update field numbers
            const container = document.getElementById('formFieldsContainer');
            Array.from(container.children).forEach((field, index) => {
                const header = field.querySelector('h4');
                header.textContent = `Field ${index + 1}`;
                
                const nameInput = field.querySelector('.field-name');
                if (!nameInput.value || nameInput.value.startsWith('field_')) {
                    nameInput.value = `field_${index + 1}`;
                }
                
                const labelInput = field.querySelector('.field-label');
                if (!labelInput.value || labelInput.value.startsWith('Field ')) {
                    labelInput.value = `Field ${index + 1}`;
                }
            });
        }

        // Enhanced save function that handles both create and update
        function saveCustomForm(editFormId = null) {
            const formName = document.getElementById('formBuilderName').value.trim();
            if (!formName) {
                alert('Please enter a form name');
                return;
            }
            
            const container = document.getElementById('formFieldsContainer');
            const fieldDivs = container.children;
            
            if (fieldDivs.length === 0) {
                alert('Please add at least one field');
                return;
            }
            
            const fields = [];
            let hasError = false;
            
            for (let i = 0; i < fieldDivs.length; i++) {
                const fieldDiv = fieldDivs[i];
                
                const name = fieldDiv.querySelector('.field-name').value.trim();
                const label = fieldDiv.querySelector('.field-label').value.trim();
                const type = fieldDiv.querySelector('.field-type').value;
                const required = fieldDiv.querySelector('.field-required').checked;
                const placeholder = fieldDiv.querySelector('.field-placeholder').value.trim();
                
                if (!name || !label) {
                    alert(`Please fill in Field Name and Display Label for Field ${i + 1}`);
                    hasError = true;
                    break;
                }
                
                // Clean field name (remove spaces, special chars)
                const cleanName = name.toLowerCase().replace(/[^a-z0-9_]/g, '_');
                
                const field = {
                    name: cleanName,
                    label: label,
                    type: type === 'textarea' ? 'text' : type,
                    required: required
                };
                
                if (placeholder) {
                    field.placeholder = placeholder;
                }
                
                // Handle options for select/radio
                if (type === 'select' || type === 'radio') {
                    const optionsText = fieldDiv.querySelector('.field-options-text').value.trim();
                    if (optionsText) {
                        field.options = optionsText.split('\n').filter(opt => opt.trim()).map(opt => opt.trim());
                    }
                }
                
                fields.push(field);
            }
            
            if (hasError) return;
            
            // Close modal
            closeFormBuilder();
            
            // Create or update the form
            if (editFormId && editFormId !== 'null') {
                updateForm(editFormId, formName, fields);
            } else {
                createForm(formName, fields);
            }
        }

        function closeFormBuilder() {
            const modal = document.getElementById('formBuilderModal');
            if (modal) {
                modal.remove();
            }
        }

        // Update existing form
        async function updateForm(formId, name, fields) {
            try {
                const response = await fetch(`/api/forms/${formId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        fields: fields,
                        database: selectedDatabase
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Form updated successfully!`);
                    if (currentTab === 'forms') {
                        loadForms();
                    }
                } else {
                    alert(`Error updating form: ${result.error}`);
                }
            } catch (error) {
                alert(`Form update failed: ${error.message}`);
            }
        }

        // Delete form
        async function deleteForm(formId, formName) {
            if (!confirm(`Are you sure you want to delete the form "${formName}"? This will also delete all submissions.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/forms/${formId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Form deleted successfully');
                    loadForms();
                } else {
                    alert(`Error deleting form: ${result.error}`);
                }
            } catch (error) {
                alert(`Form deletion failed: ${error.message}`);
            }
        }

        // View form submissions in a grid
        async function viewFormSubmissions(formId, formName) {
            try {
                const response = await fetch(`/api/forms/${formId}/submissions`);
                const data = await response.json();
                
                if (!data.success) {
                    alert('Error loading form submissions');
                    return;
                }
                
                showSubmissionsGrid(formName, data.submissions, data.form);
                
            } catch (error) {
                console.error('Error loading submissions:', error);
                alert('Failed to load form submissions');
            }
        }

        // Show submissions in a grid/table format
        function showSubmissionsGrid(formName, submissions, form) {
            const modal = document.createElement('div');
            modal.id = 'submissionsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const fields = typeof form.fields === 'string' ? JSON.parse(form.fields) : form.fields;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-6 border-b flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Form Submissions: ${formName}</h2>
                            <p class="text-gray-600 mt-1">${submissions.length} total submissions</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="exportSubmissionsCSV('${formName}', ${JSON.stringify(submissions).replace(/"/g, '&quot;')}, ${JSON.stringify(fields).replace(/"/g, '&quot;')})" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                üì• Export CSV
                            </button>
                            <button onclick="closeSubmissionsModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                ‚úï Close
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-auto p-6">
                        ${submissions.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <div class="text-4xl mb-4">üìã</div>
                                <p class="text-lg">No submissions yet</p>
                                <p class="text-sm">Share your form link to start collecting data!</p>
                            </div>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                #
                                            </th>
                                            ${fields.map(field => `
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                    ${field.label}
                                                </th>
                                            `).join('')}
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                                                Submitted
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${submissions.map((submission, index) => {
                                            const data = JSON.parse(submission.data);
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-3 text-sm text-gray-900 border-b">
                                                        ${index + 1}
                                                    </td>
                                                    ${fields.map(field => `
                                                        <td class="px-4 py-3 text-sm text-gray-900 border-b max-w-xs truncate" title="${data[field.name] || ''}">
                                                            ${data[field.name] || '-'}
                                                        </td>
                                                    `).join('')}
                                                    <td class="px-4 py-3 text-sm text-gray-500 border-b">
                                                        ${new Date(submission.submissionDate).toLocaleString()}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeSubmissionsModal() {
            const modal = document.getElementById('submissionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Export submissions to CSV
        function exportSubmissionsCSV(formName, submissions, fields) {
            if (submissions.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Create CSV content
            const headers = ['#', ...fields.map(f => f.label), 'Submitted'];
            const csvContent = [
                headers.join(','),
                ...submissions.map((submission, index) => {
                    const data = JSON.parse(submission.data);
                    const row = [
                        index + 1,
                        ...fields.map(field => {
                            const value = data[field.name] || '';
                            // Escape commas and quotes in CSV
                            return `"${value.toString().replace(/"/g, '""')}"`;
                        }),
                        `"${new Date(submission.submissionDate).toLocaleString()}"`
                    ];
                    return row.join(',');
                })
            ].join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${formName.replace(/[^a-z0-9]/gi, '_')}_submissions.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

function showFormBuilder() {
    const modal = document.createElement('div');
    modal.id = 'formBuilderModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900">Create Custom Form</h2>
                <p class="text-gray-600 mt-2">Build a form with as many fields as you need</p>
            </div>
            
            <div class="p-6">
                <!-- Form Name -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Form Name</label>
                    <input type="text" id="formBuilderName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter form name">
                </div>
                
                <!-- Fields Container -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-sm font-medium text-gray-700">Form Fields</label>
                        <button onclick="addFormField()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            ‚ûï Add Field
                        </button>
                    </div>
                    
                    <div id="formFieldsContainer" class="space-y-4">
                        <!-- Fields will be added here -->
                    </div>
                </div>
                
                <!-- Buttons -->
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="closeFormBuilder()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button onclick="saveCustomForm()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        Create Form
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add initial field
    addFormField();
    
    // Focus on form name
    document.getElementById('formBuilderName').focus();
}

function addFormField() {
    const container = document.getElementById('formFieldsContainer');
    const fieldIndex = container.children.length;
    
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
    fieldDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
            <h4 class="font-medium text-gray-900">Field ${fieldIndex + 1}</h4>
            <button onclick="removeFormField(this)" class="text-red-500 hover:text-red-700 text-sm">
                üóëÔ∏è Remove
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Field Name</label>
                <input type="text" class="field-name w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="field_name" value="field_${fieldIndex + 1}">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Display Label</label>
                <input type="text" class="field-label w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Field Label" value="Field ${fieldIndex + 1}">
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Field Type</label>
                <select class="field-type w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    <option value="text">Text</option>
                    <option value="email">Email</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                    <option value="tel">Phone</option>
                    <option value="url">URL</option>
                    <option value="textarea">Long Text</option>
                    <option value="select">Dropdown</option>
                    <option value="checkbox">Checkbox</option>
                    <option value="radio">Radio Buttons</option>
                </select>
            </div>
        </div>
        
        <div class="mt-3 flex items-center justify-between">
            <label class="flex items-center">
                <input type="checkbox" class="field-required mr-2" checked>
                <span class="text-xs text-gray-600">Required field</span>
            </label>
            
            <div class="text-xs text-gray-500">
                <input type="text" class="field-placeholder px-2 py-1 border border-gray-300 rounded text-xs w-32" placeholder="Placeholder text">
            </div>
        </div>
        
        <div class="mt-2 field-options hidden">
            <label class="block text-xs font-medium text-gray-600 mb-1">Options (one per line)</label>
            <textarea class="field-options-text w-full px-2 py-1 border border-gray-300 rounded text-sm h-16" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
        </div>
    `;
    
    container.appendChild(fieldDiv);
    
    // Add event listener for field type changes
    const typeSelect = fieldDiv.querySelector('.field-type');
    typeSelect.addEventListener('change', function() {
        const optionsDiv = fieldDiv.querySelector('.field-options');
        if (this.value === 'select' || this.value === 'radio') {
            optionsDiv.classList.remove('hidden');
        } else {
            optionsDiv.classList.add('hidden');
        }
    });
}

function removeFormField(button) {
    const fieldDiv = button.closest('.border');
    fieldDiv.remove();
    
    // Update field numbers
    const container = document.getElementById('formFieldsContainer');
    Array.from(container.children).forEach((field, index) => {
        const header = field.querySelector('h4');
        header.textContent = `Field ${index + 1}`;
        
        const nameInput = field.querySelector('.field-name');
        if (!nameInput.value || nameInput.value.startsWith('field_')) {
            nameInput.value = `field_${index + 1}`;
        }
        
        const labelInput = field.querySelector('.field-label');
        if (!labelInput.value || labelInput.value.startsWith('Field ')) {
            labelInput.value = `Field ${index + 1}`;
        }
    });
}

function saveCustomForm() {
    const formName = document.getElementById('formBuilderName').value.trim();
    if (!formName) {
        alert('Please enter a form name');
        return;
    }
    
    const container = document.getElementById('formFieldsContainer');
    const fieldDivs = container.children;
    
    if (fieldDivs.length === 0) {
        alert('Please add at least one field');
        return;
    }
    
    const fields = [];
    let hasError = false;
    
    for (let i = 0; i < fieldDivs.length; i++) {
        const fieldDiv = fieldDivs[i];
        
        const name = fieldDiv.querySelector('.field-name').value.trim();
        const label = fieldDiv.querySelector('.field-label').value.trim();
        const type = fieldDiv.querySelector('.field-type').value;
        const required = fieldDiv.querySelector('.field-required').checked;
        const placeholder = fieldDiv.querySelector('.field-placeholder').value.trim();
        
        if (!name || !label) {
            alert(`Please fill in Field Name and Display Label for Field ${i + 1}`);
            hasError = true;
            break;
        }
        
        // Clean field name (remove spaces, special chars)
        const cleanName = name.toLowerCase().replace(/[^a-z0-9_]/g, '_');
        
        const field = {
            name: cleanName,
            label: label,
            type: type === 'textarea' ? 'text' : type,
            required: required
        };
        
        if (placeholder) {
            field.placeholder = placeholder;
        }
        
        // Handle options for select/radio
        if (type === 'select' || type === 'radio') {
            const optionsText = fieldDiv.querySelector('.field-options-text').value.trim();
            if (optionsText) {
                field.options = optionsText.split('\n').filter(opt => opt.trim()).map(opt => opt.trim());
            }
        }
        
        fields.push(field);
    }
    
    if (hasError) return;
    
    // Close modal
    closeFormBuilder();
    
    // Create the form
    createForm(formName, fields);
}

function closeFormBuilder() {
    const modal = document.getElementById('formBuilderModal');
    if (modal) {
        modal.remove();
    }
}

        async function createForm(name, fields) {
            try {
                const response = await fetch('/api/create-form', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        fields: fields,
                        database: selectedDatabase
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Form created successfully! Link: ${result.form.webLink}`);
                    if (currentTab === 'forms') {
                        loadForms();
                    }
                } else {
                    alert(`Error creating form: ${result.error}`);
                }
            } catch (error) {
                alert(`Form creation failed: ${error.message}`);
            }
        }

        // Toast notification system
        document.addEventListener('show-toast', (e) => {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                e.detail.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.textContent = e.detail.message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        });
    </script>
</body>
</html>
